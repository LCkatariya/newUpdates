name: CD - Build & Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build & Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Deploy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "dist/"
          target: ${{ secrets.EC2_PATH }}
          strip_components: 1

      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: sudo systemctl reload nginx



# // if you want backup then use this code 
  # ---------- BACKUP STEP ----------
      # - name: Backup current production (keep last 5)
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.EC2_HOST }}
      #     username: ${{ secrets.EC2_USER }}
      #     key: ${{ secrets.EC2_SSH_KEY }}
      #     script: |
      #       set -e
      #       BACKUP_DIR=/var/www/backup
      #       APP_DIR=/var/www/html/app
      #       TIMESTAMP=$(date +%Y%m%d%H%M%S)

      #       mkdir -p $BACKUP_DIR

      #       if [ -d "$APP_DIR" ]; then
      #         tar -czf $BACKUP_DIR/app-$TIMESTAMP.tar.gz -C $APP_DIR .
      #       fi

      #       ls -1t $BACKUP_DIR/app-*.tar.gz | tail -n +6 | xargs -r rm -f

      # # ---------- DEPLOY STEP ----------
      # - name: Deploy new build
      #   uses: appleboy/scp-action@v0.1.7
      #   with:
      #     host: ${{ secrets.EC2_HOST }}
      #     username: ${{ secrets.EC2_USER }}
      #     key: ${{ secrets.EC2_SSH_KEY }}
      #     source: "build/*"
      #     target: "/var/www/html/app-new"

      # # ---------- SWITCH & VERIFY ----------
      # - name: Switch deployment & reload Nginx
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.EC2_HOST }}
      #     username: ${{ secrets.EC2_USER }}
      #     key: ${{ secrets.EC2_SSH_KEY }}
      #     script: |
      #       set -e
      #       cd /var/www/html

      #       rm -rf app-old || true
      #       mv app app-old || true
      #       mv app-new app

      #       sudo systemctl reload nginx

      # # ---------- ROLLBACK ON FAILURE ----------
      # - name: Rollback if deploy failed
      #   if: failure()
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.EC2_HOST }}
      #     username: ${{ secrets.EC2_USER }}
      #     key: ${{ secrets.EC2_SSH_KEY }}
      #     script: |
      #       set -e
      #       BACKUP_DIR=/var/www/backup
      #       APP_DIR=/var/www/html/app

      #       echo "Deployment failed. Rolling back..."

      #       rm -rf $APP_DIR
      #       mkdir -p $APP_DIR

      #       LATEST_BACKUP=$(ls -1t $BACKUP_DIR/app-*.tar.gz | head -n 1)
      #       tar -xzf $LATEST_BACKUP -C $APP_DIR

      #       sudo systemctl reload nginx